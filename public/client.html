<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width-device-width, initial-scale=1.0">
	<title>Charlization-canvas1</title>
	<style>
	</style>
    <!--<link rel="stylesheet" type="text/css" href="styles.css" />-->
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js" integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+" crossorigin="anonymous"></script>
    <script src="./socketio.js"></script>
	<script src="./Game.js"></script>
	<script src="./Board.js"></script>
	<script src="./Tile.js"></script>
	<script src="./Unit.js"></script>
	<script src="./Player.js"></script>
	<script src="./Canvas.js"></script>
</head>
<body>
	<canvas id="canvas1" width="1000" height="1000"></canvas>
</body>
<script>

	const localPlayer = new Player({username: "sdub", color: `hsl(${Math.random()*360}, 100%, 50%)` /* hue, saturation, lightness */})
	const game = new Game({
		players: { [socket.id]: localPlayer },
		board: new Board({x: 10, y: 10})
	})
	game.setPlayersInitialLocations(localPlayer)
	const canvas = new Canvas({canvasID: "canvas1", board: game.board})

	
	console.log(game)
	console.log(`after definition`)


	const mouse = { x: undefined, y: undefined }

	/////////////// the rest of is just listeners

	document.addEventListener("keydown", (e) => {
		console.log(e)
		socket.emit('message-from-client-to-server', message = e.key)
		if (!e.repeat) {
			if (canvas.selectedUnit) {
				e.preventDefault() // prevent screen scrolling when moving selected unit
				let command = keydownCommand(e.key)
				if (command.type === "move") {
					game.moveUnitInDirection({unit: canvas.selectedUnit, direction: command.direction})
					canvas.deselectTile()
					canvas.deselectUnit()
				}
				if (command.type === "escape") {
					canvas.deselectTile()
					canvas.deselectUnit()
				}
			}
		} else {
			//console.log(`Key "${e.key}" repeating [event: keydown]`);
		}
	});

	canvas.canvas.addEventListener("click", (event) => {
		console.log(game)
		const rect = canvas.canvas.getBoundingClientRect()
		mouse.x = Math.floor((event.x - rect.left) / canvas.tileSize)
		mouse.y = Math.floor((event.y - rect.top) / canvas.tileSize)

		if (canvas.selectedUnit) {
			let targetTile = game.board.tiles[mouse.x][mouse.y]
			game.moveUnitToTile({unit: canvas.selectedUnit, tile: targetTile})
			canvas.selectTile(targetTile)
			canvas.deselectUnit()
		} else {
			const rect = canvas.canvas.getBoundingClientRect()
			let targetTile = game.board.tiles[mouse.x][mouse.y]
			canvas.selectTile(targetTile)
			canvas.selectUnit(targetTile)
		}
		//console.log(game.localPlayer.selectedTile)
		//console.log(game.localPlayer.selectedUnit)
	})

		/*
	document.addEventListener("beforeinput", (e) => {
	console.log(`Key "${e.data}" about to be input [event: beforeinput]`);
	});

	document.addEventListener("input", (e) => {
	console.log(`Key "${e.data}" input [event: input]`);
	});

	document.addEventListener("keyup", (e) => {
	console.log(`Key "${e.key}" released [event: keyup]`);
	});

	*/

	function keydownCommand(key) {
		//console.log(key)
		if (key === "ArrowUp") { return { type: "move", direction: { x: 0, y: -1 } } }
		if (key === "ArrowDown") { return { type: "move", direction: { x: 0, y: 1 } } }
		if (key === "ArrowLeft") { return { type: "move", direction: { x: -1, y: 0 } } }
		if (key === "ArrowRight") { return { type: "move", direction: { x: 1, y: 0 } } }
		if (key === "Escape") { return { type: "escape" } }
	}

	//this.canvas.canvas.addEventListener('mousemove', () => {
	//	mouse.x = event.x
	//	mouse.y = event.y
	//})


	window.requestAnimationFrame(() => {canvas.animate(game.board, localPlayer)})

</script>

</html>